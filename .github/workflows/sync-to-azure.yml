name: Sync GitHub to Azure DevOps

on:
  push:
    branches-ignore:
      - main
  create:

env:
  AZURE_REPO_URL: "https://dev.azure.com/2028-DI1-P2-E2/2028_DI1_P2_E2/_git/API"

jobs:
  sync_all_branches:
    runs-on: ubuntu-latest
    if: github.event_name == 'create'
    
    steps:
    - name: Checkout all branches
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Git configuration
      run: |
        git config user.name "GitHub Actions Bot"
        git config user.email "github-actions-bot@users.noreply.github.com"

    - name: Add Azure DevOps remote
      env:
        AZURE_DEVOPS_TOKEN: ${{ secrets.AZURE_DEVOPS_TOKEN }}
      run: |
        git remote add azure "$AZURE_REPO_URL"
        git config --local http.https://dev.azure.com/.extraheader "AUTHORIZATION: bearer $AZURE_DEVOPS_TOKEN"

    - name: Sync all branches to Azure (except main)
      env:
        AZURE_DEVOPS_TOKEN: ${{ secrets.AZURE_DEVOPS_TOKEN }}
      run: |
        # Get all local branches except main
        branches=$(git branch -r | grep -v '\->' | grep -v 'main' | sed 's/origin\///' | tr -d ' ')
        
        for branch in $branches; do
          echo "Syncing branch: $branch"
          
          # Checkout the branch
          git checkout $branch
          
          # Push to Azure (creates branch if not exists)
          git push azure $branch || echo "Failed to push $branch, continuing..."
        done
        
        echo "Completed syncing all branches to Azure DevOps"
